version: "3.8"

services:
  cds-at:
    image: p3000/cds-connect-authoring-tool:latest
    restart: unless-stopped
    environment:
      # MongoDB connection used by the API
      MONGO_URL: "mongodb://cds-at-mongo:27017/cds_authoring"
      # CQL translator/formatter service used for CQL processing
      CQL_TO_ELM_URL: "http://cds-at-cql2elm:8080/cql/translator"
      CQL_FORMATTER_URL: "http://cds-at-cql2elm:8080/cql/formatter"
      # set to 'production' for deployment
      NODE_ENV: production
      # if you want an external proxy to handle /authoring/api, disable the built-in proxy
      API_PROXY_ACTIVE: "false"
    volumes:
      # Override api config if you want to provide custom local.json / users
      - ./api/config:/usr/src/app/api/config:ro
      # persistent uploads / state (optional)
      - ./data:/usr/src/app/data
    ports:
      - "3001:3001" # API
      - "9000:9000" # Frontend
    depends_on:
      - cds-at-mongo
      - cds-at-cql2elm

  cds-at-mongo:
    image: mongo:8
    restart: unless-stopped
    volumes:
      - ./db:/data/db
    ports:
      - "27017:27017"

  cds-at-cql2elm:
    image: cqframework/cql-translation-service:v2.6.0
    restart: unless-stopped
    ports:
      - "8080:8080"
# Notes:
# - The official upstream docker-compose exposes the frontend on 9000 and the API on 3001.
# - This compose file mounts a local api/config directory so you can place configuration
#   (local.json / local-users.json) there before starting.
