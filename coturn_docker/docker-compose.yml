version: "3.3"

services:
  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    # On Linux hosts it's recommended to use host networking so coturn can bind directly
    # to the public IP and large UDP ranges. Ensure you run this compose on a Linux server.
    network_mode: "host"
    restart: unless-stopped
    environment:
      # Update these values or provide via .env file in production
      - REALM=turn.suremeet.vn
      - EXTERNAL_IP=210.2.89.139/10.0.1.2
      - MIN_PORT=40000
      - MAX_PORT=65000
      - TURN_USER=root
      - TURN_PASS=123456
      # Optional: static auth secret for short-lived credentials generation
      - STATIC_AUTH_SECRET=replace-with-strong-secret
    # mount your TLS certificates (Let's Encrypt example) and optional local config
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./turn-config:/etc/turn:ro
    command: >
      -n
      --realm=${REALM}
      --external-ip=${EXTERNAL_IP}
      --min-port=${MIN_PORT}
      --max-port=${MAX_PORT}
      --log-file=stdout
      --no-multicast-peers
      --verbose
      --lt-cred-mech
      # Prefer use-auth-secret in production to generate short-lived credentials:
      --use-auth-secret
      --static-auth-secret=${STATIC_AUTH_SECRET}
      # Keep user:pass only for quick manual testing; remove for production when using auth-secret
      --user=${TURN_USER}:${TURN_PASS}
      # Standard TURN listening ports
      --listening-port=3478
      --tls-listening-port=5349
      # Also listen on 80/443 so existing clients using 80/443 work (optional)
      --listening-port=80
      --tls-listening-port=443
      --cert=/etc/letsencrypt/live/turn.suremeet.vn/fullchain.pem
      --pkey=/etc/letsencrypt/live/turn.suremeet.vn/privkey.pem

# Notes / guidance:
# - This compose is intended for Linux hosts where `network_mode: host` is allowed.
# - If you already run nginx on the host and it listens on 80/443, do not enable
#   coturn on 80/443 on the same host; instead run coturn on 3478/5349 and/or move
#   coturn to a separate host. You can also use nginx stream module to proxy raw TCP/TLS
#   to coturn if needed.
# - Ensure firewall (iptables, cloud security groups) allows UDP range 40000-65000
#   and TCP/UDP ports 3478/5349 and TCP 80/443 if used.
# - Replace STATIC_AUTH_SECRET with a secure secret and prefer generating short-lived
#   TURN credentials from your auth server using HMAC (recommended for production).

